<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hierarchy Mappings :: FHIRconnect</title>
    <link rel="prev" href="manual.html">
    <link rel="next" href="../../recurrence/main.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">FHIRconnect</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="FHIRconnect" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../index.html">FHIRconnect</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Grammar</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/main.html">Header</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/body.html">Body</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/preprocessor.html">Preprocessor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/Variables.html">Variables</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/Conditions.html">Condition</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/FollowedBy.html">FollowedBy</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../basics/path_operators.html">path operators</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Types of Mappings</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../main.html">Mapping types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data-type mappings</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Foundation types</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/String.html">String</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basic Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_IDENTIFIER.html">DV_IDENTIFIER</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Text Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_TEXT.html">DV_TEXT</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_CODED_TEXT.html">DV_CODED_TEXT</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/CODE_PHRASE.html">CODE_PHRASE</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/TERM_MAPPING.html">TERM_MAPPING</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Quantity Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_INTERVAL.html">DV_INTERVAL&lt;T&gt;</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_ORDINAL.html">DV_ORDINAL</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_SCALE.html">DV_SCALE</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_QUANTITY.html">DV_QUANTITY</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_COUNT.html">DV_COUNT</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_PROPORTION.html">DV_PROPORTION</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Date Time Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_DATE.html">DV_DATE</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_TIME.html">DV_TIME</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_DATE_TIME.html">DV_DATE_TIME</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_DURATION.html">DV_DURATION</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Encapsulated Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_MULTIMEDIA.html">DV_MULTIMEDIA</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_PARSABLE.html">DV_PARSABLE</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Uri Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_URI.html">DV_URI</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/DV_EHR_URI.html">DV_EHR_URI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Common Information Model</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../data-type/PARTY_IDENTIFIED.html">PARTY_IDENTIFIER</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Concept-type mappings</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="concept-mappings.html">Concept type mappings</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="SlotArchetypes.html">SlotArchetypes</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="Reference.html">Reference</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="manual.html">Manual mappings</a>
  </li>
  <li class="nav-item is-current-page" data-depth="4">
    <a class="nav-link" href="HierarchyMappings.html">Hierarchy Mappings</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Recurrence</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../recurrence/main.html">Recurrence</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../recurrence/Overwriting.html">Overwriting</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../recurrence/TransformingList.html">Transforming a list</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../recurrence/PopulatingAnEntry.html">Transforming child elements in a list</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Types of Mapping files</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/main.html">Types of mapping files</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/model-mappings.html">Model Mappings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/extension-mappings.html">Extension mappings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/extension-methods.html">Extension methods</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/composition-element.html">Mapping composition elements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/context-mappings.html">Context Mappings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../types-of-mapping-files/TemplateAgnostic.html">Template Agnostic</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Engine</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/defaults-for-fields.html">Defaults for fields</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/Fail.html">When to fail a mapping</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/bundles.html">Bundles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/demographics.html">Demographics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/references.html">References</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../engine/fhirsearch-and-aql.html">FHIRsearch and AQL</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">FHIRconnect</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../../index.html">FHIRconnect</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">FHIRconnect</a></li>
    <li>Grammar</li>
    <li>Types of Mappings</li>
    <li>Concept-type mappings</li>
    <li><a href="HierarchyMappings.html">Hierarchy Mappings</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="file:///home/severin/repos/FHIRconnect-spec/modules/ROOT/pages/types-of-mappings/concept-type/HierarchyMappings.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Hierarchy Mappings</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Hierarchy mappings are the most complex type of mappings.
Sometimes, the hierarchy between a FHIR and an openEHR model does not align properly.
For example, elements may exist on different levels in the models, leading to complications.
The hierarchy mapping is always contained in the preprocessor using the <code>hierarchy</code> key.
There can be only one hierarchy mapping; currently, we have not encountered a case where more than one is needed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="split"><a class="anchor" href="#split"></a>split</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest <code>hierarchy</code> mapping is related to events in openEHR.
<a href="https://specifications.openehr.org/releases/RM/latest/ehr.html#_observation_class">OBSERVATION</a> archetypes
in openEHR can contain a list of events.
In FHIR, these <code>events</code> are sometimes represented by a resource for each one.
Therefore, for each event in openEHR, one <code>resource</code> must be created.</p>
</div>
<div class="paragraph">
<p>The <code>with:</code> key indicates which paths are to be accessed and iterated if they are 0..n.
The <code>split</code> key can contain either <code>openEHR</code> or <code>fhir</code>.
The <code>create</code> method defines the element to create.
In the case of a <code>resource</code> or <code>archetype</code>, this type is inferred by the FHIRconnect mapping file it is included in.
The <code>create</code> method is executed for each occurrence of the correlating <code>with</code> statement.</p>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  openEhrConfig:
    archetype: openEHR-EHR-OBSERVATION.laboratory_test_result.v1
    revision: 1.2.5
  fhirConfig:
    structureDefinition: http://hl7.org/fhir/StructureDefinition/DiagnosticReport

preprocessor:
  hierarchy:
    with:
      fhir: "$resource"
      openEHR: "$archetype/data[at0001]/events[at0002]"
    split:
      fhir:
        create: "resource"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each occurrence of <code>$archetype/data[at0001]/events[at0002]</code>, the <code>split</code> is executed.
Each occurrence of an event (if there is more than one) will create a new <code>DiagnosticReport</code>.</p>
</div>
<div class="paragraph">
<p>The engine&#8217;s composition fields remain the same for each of these mappings.
One could imagine this process as cloning the composition with one event each, making the processing 1-to-1.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hierarchy-and-unique-values"><a class="anchor" href="#hierarchy-and-unique-values"></a>Hierarchy and unique values</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another case for hierarchy mappings is creating a new element based on a specific filter.</p>
</div>
<div class="paragraph">
<p>A good example of this is the FHIR <code>MedicationStatement</code>.
Without delving into the details of why the models are structured differently,
there are several challenges to address.</p>
</div>
<div class="paragraph">
<p>In FHIR, the <code>timing.event</code> contained within the <code>dosage</code> element
(see <a href="https://simplifier.net/packages/hl7.fhir.r4.core/4.0.1/files/80817">MedicationStatement</a>)
maps to the <code>time</code> of the <a href="https://specifications.openehr.org/releases/RM/Release-1.1.0/data_structures.html#_event_class">EVENT</a> in openEHR.
Therefore, if there are three <code>dosages</code> in FHIR with different <code>timing.event</code> values,
three separate <code>EVENT</code> elements must be created in the openEHR
<a href="https://ckm.openehr.org/ckm/archetypes/1013.1.4949">medication_statement</a> archetype.</p>
</div>
<div class="paragraph">
<p>Another issue is the <code>route</code> of administration.
In openEHR, the <code>route</code> of administration is contained in each <code>medication_statement</code> EVENT.
However, in FHIR, this is part of the <code>dosage</code> element.
A single <code>MedicationStatement</code> in FHIR can have three different <code>dosages</code>,
each with a different <code>route</code> of administration.
For each unique <code>route</code> of administration, a new <code>medication_statement</code> EVENT must be created in openEHR.</p>
</div>
<div class="paragraph">
<p>The same logic applies when mapping from openEHR to FHIR.
In openEHR, each <code>EVENT</code> can contain a different medication,
whereas in FHIR, each <code>MedicationStatement</code> resource can only describe one medication.
So for each openEHR <code>EVENT</code> containing a different medication, a new resource needs to be created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/MappingHierarchies.png" alt="MappingHierarchies">
</div>
</div>
<div class="paragraph">
<p>The grammar enables this with the <code>path</code> and <code>unique</code> keys.
To recap, the <code>create:</code> key specifies the type of element to be created.
The <code>path:</code> key indicates where this element should be created.
This is left empty if the element is the archetype or resource itself, as in the example shown at <code>fhir:</code>.
The <code>unique:</code> key defines the condition that triggers the creation of the new element.
The path in the <code>unique:</code> key relates to the <code>with:</code> method.
For example, in the example, we want to split the data transformation based on dosages,
so the <code>with:</code> path relates to dosage.
This will not automatically transform the dosage and event as a normal <code>with:</code> would do.
It is rather used as an indicator, as explained above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">preprocessor:
  hierarchy:
    with:
      fhir: "$resource.dosage"
      openEHR: "$archetype/data[at0001]/events[at0002]"
    #    type: "HIERARCHY" # Not necessary since hierarchy is a unique key for hierarchy mappings
    split:
      fhir:
        create: "resource"
        unique:
          - "data[at0003]/items[openEHR-EHR-CLUSTER.medication.v2]/items[at0132]"
      openEHR:
        create: "event"
        path: "$archetype/data[at0001]/events[at0002]"
        unique:
          - "route"
          - "timing.event" # If the route value differs per dosage slice, create a new event</code></pre>
</div>
</div>
<div class="paragraph">
<p>To summarize:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From FHIR-to-openEHR, for each <code>dosage</code> with a different <code>route</code> and/or <code>timing.event</code>, create a new <code>EVENT</code> in openEHR.</p>
</li>
<li>
<p>From openEHR-to-FHIR, for each event in openEHR with a different medication name (<code>[at0132]</code>), create a new <code>MedicationStatement</code> resource in FHIR.</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="manual.html">Manual mappings</a></span>
  <span class="next"><a href="../../recurrence/main.html">Recurrence</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
